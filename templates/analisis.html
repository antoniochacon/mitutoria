{% extends '_layout.html' %}
{% block body %}
	{%from '_macro.html' import nav_bar_top, titulo_1, highcharts_asignatura,highcharts_cuestionario,highcharts_asignaturas, highcharts_evalucion, highcharts_tutoria_stats%}
	{{ nav_bar_top(link_active='Alumnos',params=params, current_user=current_user) }}
	<div class="paper bg-white padding_contenido">
		{% if grupo and alumno and tutoria %}
			{{titulo_1(bg_color='bg-dark', titulo='Análisis gráfico de la tutoría')}}
			<form action="/analisis" method="POST">
				<div class="row align-items-center pb-2">
					<div class="col-sm-12 col-md-6 col-lg-4">
						<span class="text-mutted">Alumno:
						</span>
						<h5 class="strong">
							{{alumno.nombre}}
							{{alumno.apellidos}}
						</h5>
					</div>
					<div class="col-sm-12 col-md-6 col-lg-3 pb-2">
						<span class="text-mutted">Fecha:
						</span>
						<span class="strong">
							{{tutoria.fecha.strftime('%B') | capitalize}}
							-
							{{tutoria.fecha.strftime('%A') | capitalize}}
							{{tutoria.fecha.strftime('%d')}}
						</span>
						<br>
						<span class="text-mutted">Hora:
						</span>
						<span class="strong">{{tutoria.hora.strftime('%H:%M')}}</span>
					</div>
					<input type="hidden" name="current_tutoria_id" value="{{hashids_encode(tutoria.id)}}">
					<div class="row col-sm-12 col-md-12 col-lg">
						<div class="col">
							{% if params['tutoria_delete_link'] %}
								<div class="btn-group" role="group" aria-label="...">
									<button role="button" type="submit" name="selector_button" value="selector_tutoria_delete" class="btn btn-outline-warning btn-sm" title="confirmar eliminar tutoria">
										<i class="material-icons vertical-center">delete</i>
										confirmar eliminar</button>
									{% if tutoria.activa %}
										<button role="button" type="submit" name="selector_button" value="selector_tutoria_delete_archivar" class="btn btn-sm {% if tutoria.activa %} btn-outline-mutted{% else %} btn-outline-mutted{% endif %}" title="archivar tutoria">
											<i class="material-icons vertical-center {% if tutoria.activa %} color-gray-darken-1 {% endif %}">file_download</i>
										</button>
									{% endif %}
									<button role="button" type="submit" name="selector_button" value="selector_tutoria_delete_link_close" class="btn btn-outline-mutted btn-sm" title="cancelar eliminar">
										<i class="material-icons vertical-center">close</i>
									</button>
								</div>
								<br>
								<span class="text-warning small">
									Es aconsejable archivar en vez de eliminar.
									<br>
									Una vez elminada no podra ser recuperada y se perderan las estadísticas asociadas.
								<br>
							</span>
							{% else %}
								<div class="btn-group" role="group" aria-label="...">
									<button role="button" type="submit" name="selector_button" value="selector_tutoria_edit_link" class="btn btn-sm{% if tutoria.activa %} btn-outline-dark{% else %} btn-outline-mutted{% endif %}" title="cambiar fecha y hora">
										<i class="material-icons vertical-center {% if tutoria.activa %} color-gray-darken-1 {% endif %}">edit</i>
									</button>
									<button role="button" type="submit" name="selector_button" value="selector_tutoria_re_enviar_link" class="btn btn-sm {% if tutoria.activa %} btn-outline-dark{% else %} btn-outline-mutted{% endif %}" title="reenviar emails">
										<i class="material-icons vertical-center {% if tutoria.activa %} color-gray-darken-1 {% endif %}">email</i>
									</button>
									{% if tutoria.activa %}
										<button role="button" type="submit" name="selector_button" value="selector_tutoria_archivar" class="btn btn-sm {% if tutoria.activa %} btn-outline-dark{% else %} btn-outline-mutted{% endif %}" title="archivar tutoria">
											<i class="material-icons vertical-center {% if tutoria.activa %} color-gray-darken-1 {% endif %}">file_download</i>
										</button>
									{% else %}
										<button role="button" type="submit" name="selector_button" value="selector_tutoria_activar" class="btn btn-outline-dark btn-sm" title="activar tutoria">
											<i class="material-icons vertical-center">file_upload</i>
										</button>
									{% endif %}
									<button role="button" type="submit" name="selector_button" value="selector_tutoria_delete_link" class="btn btn-sm {% if tutoria.activa %} btn-outline-dark{% else %} btn-outline-mutted{% endif %}" title="eliminar tutoria">
										<i class="material-icons vertical-center{% if tutoria.activa %} color-gray-darken-1 {% endif %}">delete</i>
									</button>
									<button role="button" type="submit" name="selector_button" value="selector_tutoria_regresar_alumno" class="btn btn-sm {% if tutoria.activa %} btn-outline-dark{% else %} btn-outline-mutted{% endif %}" title="ver ficha de {{alumno.nombre}}">
										<i class="material-icons vertical-center {% if tutoria.activa %} color-gray-darken-1 {% endif %}">person</i>
									</button>
								</div>
							</div>
						{% endif %}
						<div class="col">
							{# NOTE badge #}
							<h4>
								<span class="badge badge-secondary float-right" title="{{cociente_porcentual(tutoria_informes(tutoria.id) | count, tutoria_asignaturas_count(tutoria.id))}}% de los informes recibidos">
									{{cociente_porcentual(tutoria_informes(tutoria.id) | count, tutoria_asignaturas_count(tutoria.id))}}%
								</span>
							</h4>
						</div>
					</div>
				</div>
				<div class="progress rounded-0 mb-3">
					<div
						class="progress-bar {% if tutoria.activa %} bg-secondary progress-bar-striped progress-bar-animated {% else %} bg-mutted {% endif %}"
						role="progressbar"
						aria-valuemin="0"
						aria-valuemax="100"
						style="{% if not tutoria.activa %} height:2px; {% endif %} width: {{cociente_porcentual(tutoria_informes(tutoria.id) | count, tutoria_asignaturas_count(tutoria.id))}}%;"></div>
				</div>
				{% if params['tutoria_re_enviar_link']%}
					{% include 'analisis_re_enviar_a_block.html' %}
				{% endif %}
				{% if params['tutoria_edit_link'] %}
					{% include 'analisis_tutoria_edit_block.html' %}
				{% endif %}
			</form>
			<a data-toggle="collapse" href="#analisis_cuestionario" class="collapse_header_1" aria-expanded="true" title="Analisis del cuestionario">
				<i class="material-icons vertical-center">expand_more</i>
				Analisis del cuestionario
			</a>
			<div class="collapse show" id="analisis_cuestionario">
				<div class="col pt-4 pb-3">
					{{highcharts_cuestionario(char_id='cuestionario', titulo='', color='#ffa000', df_data=df_data, grupo=grupo, tutoria_id=tutoria.id)}}
				</div>
			</div>
			<a data-toggle="collapse" href="#analisis_general_asignaturas" class="collapse_header_1" aria-expanded="false" title="Analisis general de las asiginaturas">
				<i class="material-icons vertical-center">expand_more</i>
				Analisis general de las asiginaturas
			</a>
			<div class="collapse" id="analisis_general_asignaturas">
				<div class="col pt-4 pb-3">
					{{highcharts_asignaturas(char_id='asignaturas', titulo='',color_1='#ec407a',color_2='#f48fb1', df_data=df_data, grupo=grupo, tutoria_id=tutoria.id)}}
				</div>
			</div>
			<a data-toggle="collapse" href="#analisis_detallado_asignaturas" class="collapse_header_1" aria-expanded="false" title="Analisis detallado por asignaturas">
				<i class="material-icons vertical-center">expand_more</i>
				Analisis detallado por asignatura
			</a>
			<div class="collapse" id="analisis_detallado_asignaturas">
				<div class="row">
					<div class="padding_3">
						<div class="padding_contenido">
							{% if not df_asignaturas_lista(df_data, tutoria.id) %}
								<span class="text-info">No se han recibido ningun informe para esta tutoría.</span>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="row">
					{% for asignatura in df_asignaturas_lista(df_data, tutoria.id) %}
						<div class="col-sm-12 col-md-6 col-lg-4 pb-4">
							<div class="card border-mutted">
								<div class="card-header text-center strong bg-info text-dark">
									{{asignatura}}
								</div>
								<div class="card-body">
									{{highcharts_asignatura(char_id=asignatura, asignatura=asignatura, alumno=alumno, grupo=grupo, df_data=df_data, tutoria_id=tutoria.id)}}
								</div>
								{% if asignatura_comentario(tutoria.id, asignatura) %}
									<div class="card-footer">
										<div class="strong">Observaciones:</div>
										<div class="line_break">
											{{-asignatura_comentario(tutoria.id, asignatura)-}}
										</div>
									</div>
								{% endif %}
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
			<a data-toggle="collapse" href="#analisis_evoluacion" class="collapse_header_1" aria-expanded="false" title="Analisis en el tiempo">
				<i class="material-icons vertical-center">expand_more</i>
				Analisis en el tiempo
			</a>
			<div class="collapse" id="analisis_evoluacion">
				<div class="col pt-4 pb-3">
					{{highcharts_evalucion(char_id='evalucion', titulo='',color_1='#ec407a',color_2='#f48fb1', df_data=df_data, grupo=grupo, alumno=alumno)}}
				</div>
			</div>
		{% else %}
			<div class="padding_3 text-warning text-center">
				Esta tutoria no existe.
				<br><br>
				<div class="btn-group" role="group" aria-label="...">
					<a class="btn btn-outline-dark btn-sm" href="/alumnos" role="button">ir a inicio</a>
				</div>
			</div>
		{% endif %}
	</div>
{% endblock %}
